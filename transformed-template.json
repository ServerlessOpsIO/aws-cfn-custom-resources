{
 "AWSTemplateFormatVersion": "2010-09-09",
 "Description": "AWS CFN Custom Resources Support",
 "Parameters": {
  "AwsOrganizationId": {
   "Type": "String",
   "Description": "AWS Organization ID"
  },
  "CustomResourceTopicName": {
   "Type": "String",
   "Description": "Name of the SNS topic for custom resources"
  },
  "DnsRootZoneId": {
   "Type": "String",
   "Description": "Hosted Zone ID"
  },
  "DnsRootZoneAccountId": {
   "Type": "String",
   "Description": "DNS Root Zone Account ID"
  }
 },
 "Resources": {
  "CustomResourceTopic": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "TopicName": {
     "Ref": "CustomResourceTopicName"
    },
    "DisplayName": "CFN Custom Resource Topic"
   },
   "Metadata": {
    "SamResourceId": "CustomResourceTopic"
   }
  },
  "CustomResourceTopicPolicy": {
   "Type": "AWS::SNS::TopicPolicy",
   "Properties": {
    "PolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Effect": "Allow",
       "Principal": {
        "Service": "cloudformation.amazonaws.com"
       },
       "Action": "sns:Publish",
       "Resource": {
        "Ref": "CustomResourceTopic"
       },
       "Condition": {
        "StringEquals": {
         "aws:PrincipalOrgID": [
          {
           "Ref": "AwsOrganizationId"
          }
         ]
        }
       }
      }
     ]
    },
    "Topics": [
     {
      "Ref": "CustomResourceTopic"
     }
    ]
   },
   "Metadata": {
    "SamResourceId": "CustomResourceTopicPolicy"
   }
  },
  "RegisterDnsZoneFunction": {
   "Type": "AWS::Lambda::Function",
   "Metadata": {
    "SamResourceId": "RegisterDnsZoneFunction"
   },
   "Properties": {
    "Code": {
     "S3Bucket": "awsserverlessrepo-changesets-plntc6bfnfj",
     "S3Key": "346402060170/arn:aws:serverlessrepo:us-east-1:346402060170:applications-cfn-custom-resources-versions-1.0.0/25f39222-e64d-4e20-990a-c5671f1ac341"
    },
    "Description": "Register DNS Sub Zone",
    "Handler": "function.handler",
    "MemorySize": 128,
    "Role": {
     "Fn::GetAtt": [
      "RegisterDnsZoneFunctionRole",
      "Arn"
     ]
    },
    "Runtime": "python3.12",
    "Timeout": 10,
    "Environment": {
     "Variables": {
      "DNS_ROOT_ZONE_ID": {
       "Ref": "DnsRootZoneId"
      },
      "DNS_ROOT_ZONE_ACCOUNT_ID": {
       "Ref": "DnsRootZoneAccountId"
      }
     }
    },
    "Tags": [
     {
      "Key": "lambda:createdBy",
      "Value": "SAM"
     }
    ]
   }
  },
  "RegisterDnsZoneFunctionRole": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Action": [
        "sts:AssumeRole"
       ],
       "Effect": "Allow",
       "Principal": {
        "Service": [
         "lambda.amazonaws.com"
        ]
       }
      }
     ]
    },
    "ManagedPolicyArns": [
     "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
    ],
    "Tags": [
     {
      "Key": "lambda:createdBy",
      "Value": "SAM"
     }
    ]
   }
  },
  "RegisterDnsZoneFunctionRegisterDnsSubZonePermission": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Ref": "RegisterDnsZoneFunction"
    },
    "Principal": "sns.amazonaws.com",
    "SourceArn": {
     "Ref": "CustomResourceTopic"
    }
   }
  },
  "RegisterDnsZoneFunctionRegisterDnsSubZone": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": {
     "Fn::GetAtt": [
      "RegisterDnsZoneFunction",
      "Arn"
     ]
    },
    "Protocol": "lambda",
    "TopicArn": {
     "Ref": "CustomResourceTopic"
    },
    "FilterPolicy": {
     "ResourceType": [
      "Custom::RegisterDnsZone"
     ]
    },
    "FilterPolicyScope": "MessageBody"
   }
  }
 }
}